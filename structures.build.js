var plannedStructures = [{room: 'W32N25', buildings: 
                        [{structureType: STRUCTURE_EXTENSION, pos: {x: [34,38,36,36,34], 
                                                                    y: [33,33,31,35,31]},
                                                                    RCL: 2},
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [34,38,38,36,34], 
                                                                    y: [35,31,35,37,37]},
                                                                    RCL: 3},     
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [38,35,35,35,37,37,37,39,39,39], 
                                                                    y: [37,32,34,36,32,34,36,32,34,36]},
                                                                    RCL: 4},  
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [33,33,33,40,40,40,40,32,32,32], 
                                                                    y: [32,34,36,31,33,35,37,31,33,35]},
                                                                    RCL: 5},
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [32,33,35,37,39,41,41,41,34,38], 
                                                                    y: [37,30,30,30,30,32,34,36,29,29]},
                                                                    RCL: 6}, 
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [32,34,38,39,33,39,32,32,32,39], 
                                                                    y: [27,27,27,27,28,28,29,36,26,26]},
                                                                    RCL: 7},  
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [32,35,39,33,37,41,35,39,37,41], 
                                                                    y: [30,31,31,33,33,33,35,35,37,37]},
                                                                    RCL: 8},                                                                             
                        {structureType: STRUCTURE_CONTAINER, pos: {x: [36], y: [33]}, RCL: 1},
                        {structureType: STRUCTURE_CONTAINER, pos: {x: [40], y: [29]}, RCL: 3},
                        {structureType: STRUCTURE_TOWER, pos: {x: [13,32,11], y: [9,16,46]}, RCL: 1},
                        {structureType: STRUCTURE_RAMPART, pos: {x: [8,10], y: [47,10]}, RCL: 3},
                        {structureType: STRUCTURE_SPAWN, pos: {x: [37], y: [28]}, RCL: 7},                        
                        {structureType: STRUCTURE_ROAD, pos: {  x: [],
                                                                y: []}, RCL: 3}]},
                        {room: 'W33N26', buildings: 
                        [{structureType: STRUCTURE_EXTENSION, pos: {x: [14,15,15,16,16], 
                                                                    y: [30,29,31,28,32]},
                                                                    RCL: 2},
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [13,13,13,13,14], 
                                                                    y: [28,29,31,32,32]},
                                                                    RCL: 3},     
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [14,15,15,15,16,17,17,17,17,18], 
                                                                    y: [28,27,33,34,34,27,32,33,35,34]},
                                                                    RCL: 4},  
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [14,15,17,13,12,12,12,12,11,11], 
                                                                    y: [34,35,36,27,32,30,28,26,31,30]},
                                                                    RCL: 5},
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [13,12,12,11,11,11,11,11,10,10], 
                                                                    y: [24,24,23,23,25,26,27,29,24,28]},
                                                                    RCL: 6}, 
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [8,9,9,7,10,8,10,9,7,9], 
                                                                    y: [28,27,29,29,26,30,30,25,31,31]},
                                                                    RCL: 7},  
                        {structureType: STRUCTURE_EXTENSION, pos: {x: [18,11,10,9,9,9,9,8,8,7], 
                                                                    y: [28,22,22,22,23,24,32,32,34,33]},
                                                                    RCL: 8},                                                                             
                        {structureType: STRUCTURE_CONTAINER, pos: {x: [9], y: [28]}, RCL: 6},
                        {structureType: STRUCTURE_CONTAINER, pos: {x: [], y: []}, RCL: 3},
                        {structureType: STRUCTURE_TOWER, pos: {x: [5,13,44], y: [36,5,23]}, RCL: 3},
                        {structureType: STRUCTURE_LINK, pos: {x: [22,27], y: [28,46]}, RCL: 3}, 
                        {structureType: STRUCTURE_LINK, pos: {x: [42], y: [10]}, RCL: 6},                         
                        {structureType: STRUCTURE_RAMPART, pos: {x: [47,47], y: [10,34]}, RCL: 3},
                        {structureType: STRUCTURE_ROAD, pos: {  x: [13,14,14,15,15,16,16,16,16,16,17,17,17,18,19],
                                                                y: [30,29,31,28,32,27,29,30,31,33,26,28,34,27,27]}, RCL: 2},
                        {structureType: STRUCTURE_ROAD, pos: {  x: [20,20,21,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47],
                                                                y: [26,28,27,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,2,3,4,5,6,7,8,9,10,11,11,11,11,11,11,11,11,11,11,10]}, RCL: 3},
                        {structureType: STRUCTURE_ROAD, pos: {  x: [21,21,20,22],
                                                                y: [28,30,29,29]}, RCL: 4}, 
                        {structureType: STRUCTURE_ROAD, pos: {  x: [13,14,16,18,18,14,13,12,12,12,12],
                                                                y: [33,33,35,33,35,27,26,31,29,27,25]}, RCL: 5},      
                        {structureType: STRUCTURE_ROAD, pos: {  x: [11,11,11,10,10,10,10,10,10],
                                                                y: [24,28,32,23,25,27,29,31,32]}, RCL: 6},          
                        {structureType: STRUCTURE_ROAD, pos: {  x: [9,9,9,8,8,8,7,7,7],
                                                                y: [26,30,33,29,31,33,30,32,34]}, RCL: 7},                                                            
                        {structureType: STRUCTURE_STORAGE, pos: {x: [21], y: [29]}, RCL:4}]},
                        {room: 'W35N25', buildings: 
                        [{structureType: STRUCTURE_CONTAINER, pos: {x: [], y: []}, RCL: 0}]}                        
                        ];
 
 var buildStructures = {
    
    run: function(){
        //Structure planning

        //console.log(plannedStructures);
        for(let name in Game.rooms){
            let structures = _.filter(plannedStructures, (structure) => structure.room == name);
            plannedStructures = _.filter(plannedStructures, (structure) => structure.room != name);
            
            while(structures.length && structures[0].buildings.length){
                let struct = structures[0].buildings.shift();
                let level = undefined;
                if(Game.rooms[name].controller){
                    level = Game.rooms[name].controller.level;
                }
                else {
                    level = 0;
                }                
                if(struct.RCL <= level){
                    let nBuild = Game.rooms[name].find(FIND_STRUCTURES, {
                        filter: (structure) => {
                            return (structure.structureType == struct.structureType);
                        }
                    }).length;
                    let nToBeBuild = Game.rooms[name].find(FIND_CONSTRUCTION_SITES, {
                        filter: (site) => {
                            return (site.structureType == struct.structureType);
                        }
                    }).length;
                    let nAllowed = CONTROLLER_STRUCTURES[struct.structureType][level];
                    //console.log(struct.structureType + ' ' + nBuild + ' ' + nToBeBuild + ' ' + nAllowed);
                    for(let i=0; i<struct.pos.x.length && (nBuild + nToBeBuild) < nAllowed; i++){
                        let lookStruct = [];
                        if(struct.structureType == STRUCTURE_RAMPART){
                            lookStruct = Game.rooms[name].lookForAt(LOOK_STRUCTURES,struct.pos.x[i],struct.pos.y[i]).filter((structure) => {return structure.structureType == STRUCTURE_RAMPART || structure.structureType == STRUCTURE_WALL});
                        }
                        else {
                            lookStruct = Game.rooms[name].lookForAt(LOOK_STRUCTURES,struct.pos.x[i],struct.pos.y[i]).filter((structure) => {return structure.structureType != STRUCTURE_RAMPART});
                        }
                        let lookSite = Game.rooms[name].lookForAt(LOOK_CONSTRUCTION_SITES,struct.pos.x[i],struct.pos.y[i]);
                        if(!lookStruct.length && !lookSite.length){
                            Game.rooms[name].createConstructionSite(struct.pos.x[i],struct.pos.y[i],struct.structureType);
                            console.log('Building ' + struct.structureType + ' at position x=' + struct.pos.x[i] + ' y=' + struct.pos.y[i] + ' in room ' + Game.rooms[name] + ' in game tick ' + Game.time);
                            nToBeBuild++;
                        }
                    }                    
                    
                }
            }
        }
    }
 }
 
 
 
 module.exports = buildStructures;